<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Requests • Org {{ org }}</title>
  <style>
    body{font-family:ui-sans-serif,system-ui,-apple-system; background:#0b1220; color:#f7fbff; padding:30px;}
    h2{margin-top:0}
    a{color:#3b82f6; text-decoration:none;}
    a:hover{text-decoration:underline;}
    .card{background:#121a2b; border:1px solid #243250; border-radius:16px; padding:20px; margin-bottom:30px;}
    table{width:100%; border-collapse:collapse;}
    th,td{padding:10px 12px; border-bottom:1px solid #243250; text-align:left;}
    th{color:#9fb2d0;}
    .ok{color:#14a44d;} .warn{color:#ff8c1a;} .low{color:#e44;}
    .btn{background:#243250; color:white; padding:8px 14px; border-radius:10px; text-decoration:none; margin-right:8px;}
    .btn:hover{background:#3b82f6;}
    form.inline{display:inline;}
    input[type="number"], input[type="text"]{background:#0b1220; border:1px solid #243250; color:#f7fbff; border-radius:8px; padding:6px 8px;}
    .muted{color:#9fb2d0; font-size:12px}
  </style>
</head>
<body>
  <h2>Blood Requests — Org {{ org }}</h2>
  <p><a href="{{ url_for('dashboard') }}">← Back to Dashboard</a></p>

  <!-- BANK view: All hospital requests -->
  {% if role|upper == 'BANK' %}
  <div class="card">
    <h3>All Hospital Requests</h3>
    {% if all_hospital_requests %}
      <table>
        <tr>
          <th>ID</th>
          <th>Hospital</th>
          <th>Location</th>
          <th>Blood Type</th>
          <th>Component</th>
          <th>Units Remaining</th>
          <th>Status</th>
          <th>Created</th>
          <th>Action</th>
        </tr>
        {% for r in all_hospital_requests %}
          <tr>
            <td>{{ r.request_id }}</td>
            <td>{{ r.hospital_name or r.hospital_id }}</td>
            <td>{{ r.city }}, {{ r.state }}</td>
            <td>{{ r.blood_type }}</td>
            <td>{{ r.component }}</td>
            <td>{{ r.units }}</td>
            <td>
              {% if r.status == 'FULFILLED' %}
                <span class="ok">{{ r.status }}</span>
              {% elif r.status in ['OPEN','CLAIMED','PARTIAL'] %}
                <span class="warn">{{ r.status }}</span>
              {% else %}
                <span class="low">{{ r.status }}</span>
              {% endif %}
              {% if r.accepted_by_bank_id %}
                <div class="muted">Handler: {{ r.accepted_by_bank_id }}</div>
              {% endif %}
            </td>
            <td>{{ r.created_at }}</td>
            <td>
              {# A bank can act only when:
                 - request is OPEN / CLAIMED / PARTIAL
                 - nobody else has accepted/claimed OR it's claimed by *this* bank
                 - and THIS bank hasn't rejected it already
              #}
              {% set can_act = (r.status in ['OPEN','CLAIMED','PARTIAL'])
                               and (not r.accepted_by_bank_id or r.accepted_by_bank_id == org)
                               and (r.my_bank_state != 'REJECTED') %}

              {% if can_act %}
                <form class="inline" method="post" action="{{ url_for('accept_request', request_id=r.request_id) }}">
                  <input type="number" name="units" min="1" max="{{ r.units }}" placeholder="{{ r.units }}" style="width:5rem;">
                  <input type="text" name="note" placeholder="note" style="width:10rem;">
                  <button class="btn" type="submit">Accept</button>
                </form>
                <form class="inline" method="post" action="{{ url_for('reject_request', request_id=r.request_id) }}">
                  <input type="text" name="note" placeholder="reason" style="width:10rem;">
                  <button class="btn" type="submit">Reject</button>
                </form>
              {% else %}
                {% if r.my_bank_state == 'REJECTED' %}
                  <span class="muted">Rejected by you</span>
                {% elif r.accepted_by_bank_id and r.accepted_by_bank_id != org %}
                  <span class="muted">Claimed by {{ r.accepted_by_bank_id }}</span>
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>No open requests from hospitals.</p>
    {% endif %}
  </div>
  {% endif %}

  <!-- Hospital's own requests -->
  <div class="card">
    <h3>Your Submitted Requests</h3>
    {% if requests %}
      <table>
        <tr>
          <th>ID</th>
          <th>Blood Type</th>
          <th>Component</th>
          <th>Units Remaining</th>
          <th>Urgency</th>
          <th>Status</th>
          <th>Accepted By</th>
          <th>Note</th>
          <th>Updated</th>
        </tr>
        {% for r in requests %}
          <tr>
            <td>{{ r.request_id }}</td>
            <td>{{ r.blood_type }}</td>
            <td>{{ r.component }}</td>
            <td>{{ r.units }}</td>
            <td>{{ r.level or '—' }}</td>
            <td>
              {% if r.status == 'FULFILLED' %}
                <span class="ok">{{ r.status }}</span>
              {% elif r.status in ['OPEN','CLAIMED','PARTIAL'] %}
                <span class="warn">{{ r.status }}</span>
              {% else %}
                <span class="low">{{ r.status }}</span>
              {% endif %}
            </td>
            <td>{{ r.accepted_by_bank_id or '—' }}</td>
            <td>{{ r.decision_note or '—' }}</td>
            <td>{{ r.decision_at or r.created_at }}</td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>No requests yet.</p>
    {% endif %}
  </div>

  <!-- Bank fulfilled logs -->
  {% if role|upper == 'BANK' %}
  <div class="card">
    <h3>Requests Fulfilled by Your Bank</h3>
    {% if fulfilled %}
      <table>
        <tr>
          <th>Txn ID</th>
          <th>Request ID</th>
          <th>Hospital</th>
          <th>Blood Type</th>
          <th>Component</th>
          <th>Units</th>
          <th>Level</th>
          <th>Fulfilled At</th>
        </tr>
        {% for f in fulfilled %}
          <tr>
            <td>{{ f.transaction_id }}</td>
            <td>{{ f.request_id }}</td>
            <td>{{ f.hospital }}</td>
            <td>{{ f.blood_type }}</td>
            <td>{{ f.component }}</td>
            <td>{{ f.units_fulfilled }}</td>
            <td>{{ f.level or '—' }}</td>
            <td>{{ f.fulfilled_at }}</td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>No fulfillments yet.</p>
    {% endif %}
  </div>
  {% endif %}
</body>
</html>
